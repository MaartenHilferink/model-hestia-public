//////////////////////////////////////////////////////////////////////////////////////////
//                                                                                      //
//                   (C) Hestia 2021 - PBL & TNO                                        //
//                                                                                      //
//////////////////////////////////////////////////////////////////////////////////////////

template StartingStateComponent
{
	// begin case parameters
	unit<uint32> BebouwingsObjectSrc;
	unit<uint32> ModelObject;
	parameter<Classifications/BebouwingsSector> BebouwingsSector_rel;
	// end case parameters

	parameter<yr_uint16> Startjaar_jaar := Classifications/RekenJaar/values[first(Classifications/ZichtJaar/RekenJaar_rel)];

	unit<uint32>  results := BebouwingsObjectSrc
	{
		// =============== ongewijzigde attributen uniform voor alle BC
		attribute<Invoer/SpecifiekeInstellingen/PlanRegio> PlanRegio_rel   := BebouwingsObjectSrc/buurt_rel;
		attribute<ModelObject>                             ModelObject_rel := rlookup(BebouwingsObjectSrc/ModelObjectKey, ModelObject/ModelObjectKey);
		attribute<Invoer/RuimtelijkeData/BestaandeWarmtenetten/Aflevergebied_data> Aflevergebied_rel := point_in_polygon(point, Invoer/RuimtelijkeData/BestaandeWarmtenetten/Aflevergebied_data/geometry);

		// =============== attributen die per Rekenstap kunnen wijzigen door toepassing van GebouwOpties
		attribute<Classifications/SchilLabel>  SchilLabel_rel := =(BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning) 
			? 'MakeDefined(BebouwingsObjectSrc/SchilLabel_rel, Classifications/schillabel/V/N)'
			: 'ModelObject/SchilLabel_rel[ ModelObject_rel]';
			
		attribute<Classifications/SchilLabel>  DefaultLabel_rel := MakeDefined(BebouwingsObjectSrc/SchilLabel_rel, ModelObject/SchilLabel_rel[ ModelObject_rel]);
			
		attribute<Classifications/Schillabel>  StartLabel_rel := SchilLabel_rel;
		attribute<units/yr_uint16> Bouwjaar  := =BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning ?
			'Invoer/RuimtelijkeData/BAG/vbo_woonfunctie_studiegebied/bouwjaar' : 'Invoer/RuimtelijkeData/BAG/vbo_utiliteit_studiegebied/bouwjaar';
		attribute<units/yr_uint16> Sloopjaar := =BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning ?
			'Invoer/RuimtelijkeData/BAG/vbo_woonfunctie_studiegebied/sloopjaar' : 'Invoer/RuimtelijkeData/BAG/vbo_utiliteit_studiegebied/sloopjaar';
		attribute<Classifications/Eigendom> Eigendom_rel  := =BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning ?
			'Invoer/RuimtelijkeData/BAG/vbo_woonfunctie_studiegebied/Eigendom_rel' : 'Invoer/RuimtelijkeData/BAG/vbo_utiliteit_studiegebied/Eigendom_rel';
	
		unit<uint32> BestaandAflevergebied := Invoer/RuimtelijkeData/BestaandeWarmtenetten/Aflevergebied_data;
		unit<uint32> BestaandWarmtenet     := Invoer/RuimtelijkeData/BestaandeWarmtenetten/Warmtenetten;
		attribute<BestaandAflevergebied> BestaandAflevergebied_rel := point_in_polygon(BebouwingsObjectSrc/point , BestaandAflevergebied/Geometry);
		attribute<BestaandWarmtenet>     BestaandWarmtenet_rel     := BestaandAflevergebied/Warmtenet_rel[BestaandAflevergebied_rel];
		
		attribute<bool> Gasloos := =Invoer/StartgegevensAan ? 'BebouwingsObjectSrc/Gasloos' : 'const(false,.)';

		attribute<Classifications/GebouwOptie> GebouwOptie_rel :=
				gasloos && not(isdefined(BestaandAflevergebied_rel)) && Defaultlabel_rel >=  Classifications/schillabel/V/C ? Classifications/GebouwOptie/V/Bioketel_zKD
			:	gasloos && not(isdefined(BestaandAflevergebied_rel)) && Defaultlabel_rel < Classifications/schillabel/V/C ? Classifications/GebouwOptie/V/LweWP_zKD
			:	isdefined(BestaandAflevergebied_rel) && BestaandAflevergebied/Startjaar[BestaandAflevergebied_rel] <= 2000w ?  Classifications/GebouwOptie/V/Gebied_zK
			:	ModelObject/StartOptie_rel[ModelObject_rel];
		
		container Functioneel := for_each_nedv(
				Classifications/FunctioneleVraag/name,
				'BaseValues/'+ Classifications/FunctioneleVraag/name,
				.,
				GJ_yr)
		{
			attribute<bool> RV_N1_check(..) := abs(RV_N1_per_Bouwdeel/Total - BaseValues/RV) < 0.001;
			attribute<GJ_yr> RV_N1 (..) := BaseValues/RV, IntegrityCheck ="RV_N1_check";
		
			container RV_N1_per_Bouwdeel := for_each_nedv(
				Classifications/bouwdeel/name,
					'BaseValues/RV / Bouwdelen/Totaal
				*	Bouwdelen/'+ Classifications/bouwdeel/name + '
				*	Classifications/bouwdeel/verlies[Classifications/bouwdeel/V/'+Classifications/bouwdeel/name+'] / Bouwdelen/Norm_verliesfactor',
				..,
				GJ_yr)
				{
					attribute<GJ_yr> Total (...) := ='add('+AsItemList(Classifications/bouwdeel/name)+')';
				}
			
			container BaseValues := for_each_nedv(
				Classifications/FunctioneleVraag/name,
				'Invoer/Kengetallen/Bebouwing/'+Classifications/BebouwingsSector/name[BebouwingsSector_rel]+'/Results/Asl/'+Classifications/FunctioneleVraag/name+'[ModelObject_rel]* nrAansluitingen_i +
				 Invoer/Kengetallen/Bebouwing/'+Classifications/BebouwingsSector/name[BebouwingsSector_rel]+'/Results/Opp/'+Classifications/FunctioneleVraag/name+'[ModelObject_rel] * Oppervlakte_i',
				..,
				GJ_yr);
		}
		
			
		container InstallatiePerProduct := for_each_nedv(Classifications/Product/name
			, 'Classifications/GebouwOptie/PerProduct/'+Classifications/Product/name+'[GebouwOptie_rel]'
			, .
			, Classifications/Installatie)
		{
			container LastVervanging := for_each_nedv(
				Classifications/Product/name,
				'(uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Classifications/Installatie/Levensduur[InstallatiePerProduct/' + Classifications/Product/name + ']))[yr_uint16]',
				..,
				yr_uint16)
				{
					attribute<yr_uint16> KK (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes/Levensduur[InstallatiePerProduct/KK]))[yr_uint16];
					attribute<yr_uint16> VT (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes/Levensduur[InstallatiePerProduct/VT]))[yr_uint16];
					attribute<yr_uint16> DK (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes/Levensduur[InstallatiePerProduct/DK]))[yr_uint16];
				}
				
			attribute<Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes> KK (..) := Gasloos || isdefined(BestaandAflevergebied_rel) ? Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes/V/Elek : Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes/V/Gas;
			attribute<Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes> VT (..) := const(Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes/V/Nat, ..);
			attribute<Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes> DK (..) := const(Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes/V/geen,..);

			attribute<Classifications/AfgifteSysteem> AfgifteSysteem_init (..) := const(Classifications/AfgifteSysteem/V/MTAS, ..);
			attribute<Classifications/AfgifteSysteem> AS (..) := max_elem(
				 AfgifteSysteem_init
				,Classifications/Performance/AfgifteSysteem_rel[SPF/PerformancePerProduct/RVb]
				,Classifications/Performance/AfgifteSysteem_rel[SPF/PerformancePerProduct/RVp]
			);
		}
		
		container Func2Meter := CalculationSchemes/FunctioneelToMetervraag(.);
		container BemeterdeGebouwInput_rel := for_each_nedv(Classifications/Product/name
			, 'rlookup(Classifications/Performance/Input_rel, Classifications/BemeterdeGebouwInput/nr_OrgEntity)[SPF/PerformancePerProduct/'+Classifications/Product/name+']'
			, .
			, Classifications/BemeterdeGebouwInput
			);

		container SPF := Func2Meter/SPF
		{
			container PerformancePerProduct := Func2Meter/SPF/PerformancePerProduct;
		}

		container Bouwdelen := BebouwingsObjectSrc/Bouwdelen
		{
			container BouwDeelVerliesFactor := for_each_nedv(
				Classifications/Bouwdeel/name,
				'Classifications/Bouwdeel/Verlies[Classifications/Bouwdeel/V/'+Classifications/Bouwdeel/name+'] * Bouwdelen/'+Classifications/Bouwdeel/name+'',
				(..),
				m2);
			
			
			attribute<ratio> Norm_verliesfactor (..) := ='add('+AsItemList('BouwDeelVerliesFactor/'+Classifications/Bouwdeel/name)+') / Totaal';
		}
		
		container Kapitaallasten
		{
			//Aansluitbijdrages
			attribute<Eur_yr> Kji_Asl_Enet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_Asl_Enet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji_Asl_Gnet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_Asl_Gnet (results) := const(0[Eur_yr], results);

			//Investeringen
			attribute<Eur_yr> Kji30_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi30_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji20_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi20_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji15_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi15_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji_gv   (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_gv   (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kj_gv_incentive (results) := const(0[Eur_yr], results);

			attribute<Eur_yr> Kji_LTAS (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_LTAS (results) := const(0[Eur_yr], results);

			//Subsidies
			attribute<Eur_yr> Oji_s_LO_30 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_LO_20 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_LO_15 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_gv    (results) := const(0[Eur_yr], results);			
		}

		// =============== attributen die ook per GebiedOptie kunnen wijzigen
		attribute<Classifications/WarmteOptie> WarmteOptie_rel := Classifications/GebouwOptie/WarmteOptie_rel [ GebouwOptie_rel ];

		unit<uint32> AfnameGebied := ..../AfnameGebied;
		attribute<AfnameGebied> AfnameGebied_rel := const((0 / 0)[AfnameGebied], results);
	}
	unit<uint8> ModelObjectKeyDomein;
	unit<uint32>   PreStartJaar := subset(Results/bouwjaar < Startjaar_jaar)
	{
		unit<uint32> buurt         := Invoer/RuimtelijkeData/StudieGebied/buurt;
		unit<uint32> Aflevergebied := Invoer/RuimtelijkeData/BestaandeWarmtenetten/Aflevergebied_data;
		
		attribute<Geography/rdc_meter>         point             := Results/point[nr_orgentity];
		attribute<Geography/rdc_meter>         geometry          := Results/geometry[nr_orgentity];
		attribute<string>                      code              := Results/code[nr_orgentity];
		attribute<string>                      label             := Results/label[nr_orgentity], DialogType = "labelText";
		attribute<buurt>                       Buurt_rel         := Results/Buurt_rel[nr_orgentity];
		attribute<Aflevergebied>               Aflevergebied_rel := Results/Aflevergebied_rel[nr_OrgEntity];
		attribute<BebouwingsTypeDomein>        BebouwingsType    := Results/BebouwingsType[nr_orgentity];
		attribute<units/yr_uint16>             Bouwjaar          := Results/Bouwjaar[nr_orgentity];
		attribute<units/yr_uint16>             Sloopjaar         := Results/Sloopjaar[nr_orgentity];
		attribute<Classifications/Eigendom>    Eigendom_rel      := Results/Eigendom_rel[nr_orgentity];
		attribute<ratio>                       ResterendNu       := const(1.0,.);
		attribute<ModelObjectKeyDomein>        ModelObjectKey    := Results/ModelObjectKey[nr_orgentity];
		attribute<nrAsl>                       nrAansluitingen_i := Results/nrAansluitingen_i[nr_orgentity];
		attribute<m2>                          Oppervlakte_i     := Results/Oppervlakte_i[nr_orgentity];
		attribute<pand_asl>                    pand_aandeel      := Results/pand_aandeel[nr_orgentity];
		attribute<Classifications/Schillabel>  Schillabel_rel    := Results/Schillabel_rel[nr_orgentity];
		attribute<Classifications/Schillabel>  Defaultlabel_rel  := Results/Defaultlabel_rel[nr_orgentity];
		attribute<Classifications/WarmteOptie> WarmteOptie_rel   := Results/WarmteOptie_rel[nr_orgentity];
		attribute<Classifications/Schillabel>  Startlabel_rel    := Results/Startlabel_rel[nr_orgentity];
		
		unit<uint8>  BebouwingsTypeDomein := Results/BebouwingsTypeDomein;
		unit<uint32> AfnameGebied         := Results/AfnameGebied;
		
		attribute<AfnameGebied>                AfnameGebied_rel   := Results/AfnameGebied_rel[nr_orgentity];
		attribute<Classifications/GebouwOptie> GebouwOptie_rel    := Results/GebouwOptie_rel[nr_orgentity];
		
		container Aansluitingen
		{
			attribute<nrAsl> GNet(PreStartJaar) :=				
				not(IsDefined(Aflevergebied_rel) && Aflevergebied/StartJaar[Aflevergebied_rel] <= Startjaar_jaar) && Results/bouwjaar[nr_orgentity] < 2025w // TODO: Check! 
				? nrAansluitingen_i
				: 0[nrAsl];
		}
		
		container Functioneel
		{
			container RV_N1_per_Bouwdeel := for_each_nedv(
				Classifications/Bouwdeel/name,
				'Results/Functioneel/RV_N1_per_Bouwdeel/'+Classifications/Bouwdeel/name+'[nr_orgentity]',
				..,
				GJ_yr);
			container BaseValues := for_each_nedv(
				Classifications/FunctioneleVraag/name,
				'Results/Functioneel/BaseValues/'+Classifications/FunctioneleVraag/name+'[nr_orgentity]',
				..,
				GJ_yr);
		}

		container BemeterdeGebouwInput_rel :=  for_each_nedv(
			classifications/Product/name,
			'Results/BemeterdeGebouwInput_rel/' + Classifications/Product/Name + '[nr_orgentity]',
			.,
			Classifications/BemeterdeGebouwInput );
		
		container SPF := for_each_nedv(
			classifications/Product/name,
			'Results/SPF/' + Classifications/Product/Name + '[nr_orgentity]',
			.,
			float64)
		{
			container PerformancePerProduct :=  for_each_nedv(
			classifications/Product/name,
			'Results/SPF/PerformancePerProduct/' + Classifications/Product/Name + '[nr_orgentity]',
			..,
			Classifications/Performance);
		}

		Container Bouwdelen := for_each_nedv(
			classifications/bouwdeel/name,
			'Results/Bouwdelen/' + Classifications/Bouwdeel/Name + '[nr_orgentity]',
			.,
			m2)
		{
			container LastVervanging := for_each_nedv(
				classifications/bouwdeel/name,
				'(uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), classifications/bouwdeel/levensduur[/Classifications/Bouwdeel/V/' +  /Classifications/Bouwdeel/name + ']))[yr_uint16]',
				..,
				yr_uint16);
			container Isolatie := for_each_nedv(
				classifications/bouwdeel/name,
				'makedefined( BebouwingsObjectSrc/Bouwdelen/Isolatie/'+classifications/bouwdeel/name+'[nr_orgentity]
				 , Classifications/schillabel/default_bouwdeelkwaliteit/'+classifications/bouwdeel/name+'[Defaultlabel_rel])',
				..,
				Classifications/IsolatieNiveau);
		}
		
		container Gebied
		{
			attribute<float64> n      (..) := Results/Gebied/n[nr_orgentity];
			attribute<float64> MEAN_x (..) := Results/Gebied/MEAN_x[nr_orgentity];
			attribute<float64> MEAN_y (..) := Results/Gebied/MEAN_y[nr_orgentity];
			attribute<float64> SSD_xx (..) := Results/Gebied/SSD_xx[nr_orgentity];
			attribute<float64> SSD_xy (..) := Results/Gebied/SSD_xy[nr_orgentity];
			attribute<float64> SSD_yy (..) := Results/Gebied/SSD_yy[nr_orgentity];
		}
		
		container Kapitaallasten
		{
			attribute<Eur_yr> Kji_Asl_Enet    (..) := Results/Kapitaallasten/Kji_Asl_Enet[nr_orgentity];
			attribute<Eur_yr> Kmi_Asl_Enet    (..) := Results/Kapitaallasten/Kmi_Asl_Enet[nr_orgentity];
			attribute<Eur_yr> Kji_Asl_Gnet    (..) := Results/Kapitaallasten/Kji_Asl_Gnet[nr_orgentity];
			attribute<Eur_yr> Kmi_Asl_Gnet    (..) := Results/Kapitaallasten/Kmi_Asl_Gnet[nr_orgentity];
			attribute<Eur_yr> Kji30_LO        (..) := Results/Kapitaallasten/Kji30_LO[nr_orgentity];
			attribute<Eur_yr> Kmi30_LO        (..) := Results/Kapitaallasten/Kmi30_LO[nr_orgentity];
			attribute<Eur_yr> Kji20_LO        (..) := Results/Kapitaallasten/Kji20_LO[nr_orgentity];
			attribute<Eur_yr> Kmi20_LO        (..) := Results/Kapitaallasten/Kmi20_LO[nr_orgentity];
			attribute<Eur_yr> Kji15_LO        (..) := Results/Kapitaallasten/Kji15_LO[nr_orgentity];
			attribute<Eur_yr> Kmi15_LO        (..) := Results/Kapitaallasten/Kmi15_LO[nr_orgentity];
			attribute<Eur_yr> Kji_gv          (..) := Results/Kapitaallasten/Kji_gv[nr_orgentity];
			attribute<Eur_yr> Kmi_gv          (..) := Results/Kapitaallasten/Kmi_gv[nr_orgentity];
			attribute<Eur_yr> Kj_gv_incentive (..) := Results/Kapitaallasten/Kj_gv_incentive[nr_orgentity];
			attribute<Eur_yr> Kji_LTAS        (..) := Results/Kapitaallasten/Kji_LTAS[nr_orgentity];
			attribute<Eur_yr> Kmi_LTAS        (..) := Results/Kapitaallasten/Kmi_LTAS[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_30     (..) := Results/Kapitaallasten/Oji_s_LO_30[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_20     (..) := Results/Kapitaallasten/Oji_s_LO_20[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_15     (..) := Results/Kapitaallasten/Oji_s_LO_15[nr_orgentity];
			attribute<Eur_yr> Oji_s_gv        (..) := Results/Kapitaallasten/Oji_s_gv[nr_orgentity];
		}
		
		container InstallatiePerProduct := for_each_nedv(Classifications/Product/name
		, 'Results/InstallatiePerProduct/'+Classifications/Product/name+'[nr_orgentity]'
		, .
		, Classifications/Installatie)
		{
			container LastVervanging := for_each_nedv(
				Classifications/Product/name,
				'Results/InstallatiePerProduct/LastVervanging/'+Classifications/Product/name+'[nr_orgentity]',
				..,
				yr_uint16)
				{
					attribute<yr_uint16> KK (...) := Results/InstallatiePerProduct/LastVervanging/KK[nr_orgentity];
					attribute<yr_uint16> VT (...) := Results/InstallatiePerProduct/LastVervanging/VT[nr_orgentity];
					attribute<yr_uint16> DK (...) := Results/InstallatiePerProduct/LastVervanging/DK[nr_orgentity];
					attribute<yr_uint16> AS (...) := Results/InstallatiePerProduct/LastVervanging/AS[nr_orgentity];
				}
			
			attribute<Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes> KK (..) := Results/InstallatiePerProduct/KK[nr_orgentity];
			attribute<Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes> VT (..) := Results/InstallatiePerProduct/VT[nr_orgentity];
			attribute<Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes> DK (..) := Results/InstallatiePerProduct/DK[nr_orgentity];
			attribute<Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes> AS (..) := Results/InstallatiePerProduct/DK[nr_orgentity];
		}
	}
}
