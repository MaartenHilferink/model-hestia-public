//////////////////////////////////////////////////////////////////////////////////////////
//                                                                                      //
//                   (C) VESTA 2020 - Planbureau voor de Leefomgeving                   //
//                                                                                      //
//////////////////////////////////////////////////////////////////////////////////////////

template StartingStateComponent
{
	// begin case parameters
	unit<uint32> BebouwingsObjectSrc;
	unit<uint32> ModelObject;
	parameter<Classifications/BebouwingsSector> BebouwingsSector_rel;
	// end case parameters

	parameter<yr_uint16> Startjaar_jaar := Classifications/RekenJaar/values[first(Classifications/ZichtJaar/RekenJaar_rel)];

	unit<uint32>  results := BebouwingsObjectSrc
	{
		// =============== ongewijzigde attributen uniform voor alle BC
		attribute<Invoer/SpecifiekeInstellingen/PlanRegio> PlanRegio_rel   := BebouwingsObjectSrc/buurt_rel;
		attribute<ModelObject>                             ModelObject_rel := rlookup(BebouwingsObjectSrc/ModelObjectKey, ModelObject/ModelObjectKey);

		// =============== attributen die per Rekenstap kunnen wijzigen door toepassing van GebouwOpties
		attribute<Classifications/SchilLabel>  SchilLabel_rel := =(BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning) 
			? 'MakeDefined(BebouwingsObjectSrc/SchilLabel_rel, Classifications/schillabel/V/N)'
			: 'ModelObject/SchilLabel_rel[ ModelObject_rel]';
			
		attribute<Classifications/SchilLabel>  DefaultLabel_rel := MakeDefined(BebouwingsObjectSrc/SchilLabel_rel, ModelObject/SchilLabel_rel[ ModelObject_rel]);
			
		attribute<Classifications/Schillabel>  StartLabel_rel := SchilLabel_rel;
		attribute<units/yr_uint16> Bouwjaar  := =BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning ?
			'Invoer/RuimtelijkeData/BAG/vbo_woonfunctie_studiegebied/bouwjaar' : 'Invoer/RuimtelijkeData/BAG/vbo_utiliteit_studiegebied/bouwjaar';
		attribute<units/yr_uint16> Sloopjaar := =BebouwingsSector_rel == Classifications/BebouwingsSector/V/Woning ?
			'Invoer/RuimtelijkeData/BAG/vbo_woonfunctie_studiegebied/sloopjaar' : 'Invoer/RuimtelijkeData/BAG/vbo_utiliteit_studiegebied/sloopjaar';
	
		attribute<Classifications/GebouwOptie> GebouwOptie_rel := 
			Restwarmte/GebruikRestWarmte[Planregio_rel] ? Classifications/gebiedsOptie/GebouwOptie_rel[PlanregioWarmteAllocatie_Remove[Planregio_rel]] :
			ModelObject/StartOptie_rel[ModelObject_rel]; // laast toegepaste optie
			
		container InstallatiePerProduct := for_each_nedv(Classifications/Product/name
			, 'Classifications/GebouwOptie/PerProduct/'+Classifications/Product/name+'[GebouwOptie_rel]'
			, .
			, Classifications/Installatie)
		{
			container LastVervanging := for_each_nedv(
				Classifications/Product/name,
				'(uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Classifications/Installatie/Levensduur[InstallatiePerProduct/' + Classifications/Product/name + ']))[yr_uint16]',
				..,
				yr_uint16)
				{
					attribute<yr_uint16> KK (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes/Levensduur[InstallatiePerProduct/KK]))[yr_uint16];
					attribute<yr_uint16> VT (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes/Levensduur[InstallatiePerProduct/VT]))[yr_uint16];
					attribute<yr_uint16> DK (...) := (uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes/Levensduur[InstallatiePerProduct/DK]))[yr_uint16];
				}
				
			attribute<Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes> KK (..) := const(Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes/V/Gas, ..);
			attribute<Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes> VT (..) := const(Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes/V/Nat, ..);
			attribute<Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes> DK (..) := const(Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes/V/geen,..);
		}
		
		container BemeterdeGebouwInput_rel := for_each_nedv(Classifications/Product/name
			, 'rlookup(Classifications/Performance/Input_rel, Classifications/BemeterdeGebouwInput/nr_OrgEntity)[PerformancePerProduct/'+Classifications/Product/name+']'
			, .
			, Classifications/BemeterdeGebouwInput
			);
			
		container Performance_key1 := for_each_nedv(Classifications/Product/name
			, 'Classifications/Installatie/name[InstallatiePerProduct/'+Classifications/Product/name+']+''.'' + Classifications/SchilLabel/name[SchilLabel_rel] + ''.' + Classifications/Product/TypeName+''''
			, .
			, string
		), isHidden = "True";

		container Performance_key2 := for_each_nedv(Classifications/Product/name
			, 'Classifications/Installatie/name[InstallatiePerProduct/'+Classifications/Product/name+']+''.x.' + Classifications/Product/TypeName+''''
			,.
			, string
		), isHidden = "True";

		container PerformancePerProduct := for_each_nedv(Classifications/Product/name
			,	replace(
					'MakeDefined('
						'rlookup(Performance_key1/@P, Classifications/Performance/code), '
						'rlookup(Performance_key2/@P, Classifications/Performance/code),'
						'rlookup(''geen.x.x'', Classifications/Performance/code)'
					')'
				, '@P', Classifications/Product/name)
			, .
			, Classifications/Performance
		);

		attribute<Classifications/AfgifteSysteem> AfgifteSysteem_init := const(Classifications/AfgifteSysteem/V/MTAS, .);
		attribute<Classifications/AfgifteSysteem> AfgifteSysteem_rel  := max_elem(
			 AfgifteSysteem_init
			,Classifications/Performance/AfgifteSysteem_rel[PerformancePerProduct/RVb]
			,Classifications/Performance/AfgifteSysteem_rel[PerformancePerProduct/RVp]
		);

		container Bouwdelen := BebouwingsObjectSrc/Bouwdelen;
		
		container Kapitaallasten
		{
			//Aansluitbijdrages
			attribute<Eur_yr> Kji_Asl_Enet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_Asl_Enet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji_Asl_Gnet (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_Asl_Gnet (results) := const(0[Eur_yr], results);

			//Investeringen
			attribute<Eur_yr> Kji30_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi30_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji20_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi20_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji15_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi15_LO (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kji_gv   (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_gv   (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kj_gv_incentive (results) := const(0[Eur_yr], results);

			attribute<Eur_yr> Kji_LTAS (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Kmi_LTAS (results) := const(0[Eur_yr], results);

			//Subsidies
			attribute<Eur_yr> Oji_s_LO_30 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_LO_20 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_LO_15 (results) := const(0[Eur_yr], results);
			attribute<Eur_yr> Oji_s_gv    (results) := const(0[Eur_yr], results);			
		}

		// =============== attributen die ook per GebiedOptie kunnen wijzigen
		attribute<Classifications/WarmteOptie> WarmteOptie_rel := Classifications/GebouwOptie/WarmteOptie_rel [ GebouwOptie_rel ];

		unit<uint32> AfnameGebied := ..../AfnameGebied;
		attribute<AfnameGebied> AfnameGebied_rel := const((0 / 0)[AfnameGebied], results);
	}
	unit<uint8> ModelObjectKeyDomein;
	unit<uint32>   PreStartJaar := subset(Results/bouwjaar < Startjaar_jaar)
	{
		attribute<Geography/rdc_meter>                       point             := Results/point[nr_orgentity];
		attribute<Geography/rdc_meter>                       geometry          := Results/geometry[nr_orgentity];
		attribute<string>                                    code              := Results/code[nr_orgentity];
		attribute<string>                                    label             := Results/label[nr_orgentity], DialogType = "labelText";
		attribute<Invoer/RuimtelijkeData/StudieGebied/buurt> Buurt_rel         := Results/Buurt_rel[nr_orgentity];
		attribute<BebouwingsTypeDomein>                      BebouwingsType    := Results/BebouwingsType[nr_orgentity];
		attribute<units/yr_uint16>                           Bouwjaar          := Results/Bouwjaar[nr_orgentity];
		attribute<units/yr_uint16>                           Sloopjaar         := Results/Sloopjaar[nr_orgentity];
		attribute<ratio>                                     ResterendNu       := const(1.0,.);
		attribute<ModelObjectKeyDomein>                      ModelObjectKey    := Results/ModelObjectKey[nr_orgentity];
		attribute<nrAsl>                                     nrAansluitingen_i := Results/nrAansluitingen_i[nr_orgentity];
		attribute<m2>                                        Oppervlakte_i     := Results/Oppervlakte_i[nr_orgentity];
		attribute<pand_asl>                                  pand_aandeel      := Results/pand_aandeel[nr_orgentity];
		attribute<Classifications/Schillabel>                Schillabel_rel    := Results/Schillabel_rel[nr_orgentity];
		attribute<Classifications/Schillabel>                Defaultlabel_rel  := Results/Defaultlabel_rel[nr_orgentity];
		attribute<Classifications/WarmteOptie>               WarmteOptie_rel   := Results/WarmteOptie_rel[nr_orgentity];
		attribute<Classifications/Schillabel>                Startlabel_rel    := Results/Startlabel_rel[nr_orgentity];
		
		unit<uint8>  BebouwingsTypeDomein := Results/BebouwingsTypeDomein;
		unit<uint32> AfnameGebied         := Results/AfnameGebied;
		
		attribute<Classifications/AfgifteSysteem>           AfgifteSysteem_rel := Results/AfgifteSysteem_rel[nr_orgentity];
		attribute<AfnameGebied>                             AfnameGebied_rel   := Results/AfnameGebied_rel[nr_orgentity];
		attribute<Classifications/GebouwOptie>              GebouwOptie_rel    := Results/GebouwOptie_rel[nr_orgentity];
		
		container BemeterdeGebouwInput_rel :=  for_each_nedv(
			classifications/Product/name,
			'Results/BemeterdeGebouwInput_rel/' + Classifications/Product/Name + '[nr_orgentity]',
			.,
			Classifications/BemeterdeGebouwInput );
		Container Bouwdelen := for_each_nedv(
			classifications/bouwdeel/name,
			'Results/Bouwdelen/' + Classifications/Bouwdeel/Name + '[nr_orgentity]',
			.,
			m2)
		{
			container LastVervanging := for_each_nedv(
				classifications/bouwdeel/name,
				'(uint16(Startjaar_jaar) - mod(uint16(Startjaar_jaar - Bouwjaar), classifications/bouwdeel/levensduur[/Classifications/Bouwdeel/V/' +  /Classifications/Bouwdeel/name + ']))[yr_uint16]',
				..,
				yr_uint16);
			container Isolatie := for_each_nedv(
				classifications/bouwdeel/name,
				'Classifications/schillabel/default_bouwdeelkwaliteit/'+classifications/bouwdeel/name+'[Defaultlabel_rel]',
				..,
				Classifications/IsolatieNiveau);
		}
		
		container Gebied
		{
			attribute<float64> n      (..) := Results/Gebied/n[nr_orgentity];
			attribute<float64> MEAN_x (..) := Results/Gebied/MEAN_x[nr_orgentity];
			attribute<float64> MEAN_y (..) := Results/Gebied/MEAN_y[nr_orgentity];
			attribute<float64> SSD_xx (..) := Results/Gebied/SSD_xx[nr_orgentity];
			attribute<float64> SSD_xy (..) := Results/Gebied/SSD_xy[nr_orgentity];
			attribute<float64> SSD_yy (..) := Results/Gebied/SSD_yy[nr_orgentity];
		}
		
		container Kapitaallasten
		{
			attribute<Eur_yr> Kji_Asl_Enet    (..) := Results/Kapitaallasten/Kji_Asl_Enet[nr_orgentity];
			attribute<Eur_yr> Kmi_Asl_Enet    (..) := Results/Kapitaallasten/Kmi_Asl_Enet[nr_orgentity];
			attribute<Eur_yr> Kji_Asl_Gnet    (..) := Results/Kapitaallasten/Kji_Asl_Gnet[nr_orgentity];
			attribute<Eur_yr> Kmi_Asl_Gnet    (..) := Results/Kapitaallasten/Kmi_Asl_Gnet[nr_orgentity];
			attribute<Eur_yr> Kji30_LO        (..) := Results/Kapitaallasten/Kji30_LO[nr_orgentity];
			attribute<Eur_yr> Kmi30_LO        (..) := Results/Kapitaallasten/Kmi30_LO[nr_orgentity];
			attribute<Eur_yr> Kji20_LO        (..) := Results/Kapitaallasten/Kji20_LO[nr_orgentity];
			attribute<Eur_yr> Kmi20_LO        (..) := Results/Kapitaallasten/Kmi20_LO[nr_orgentity];
			attribute<Eur_yr> Kji15_LO        (..) := Results/Kapitaallasten/Kji15_LO[nr_orgentity];
			attribute<Eur_yr> Kmi15_LO        (..) := Results/Kapitaallasten/Kmi15_LO[nr_orgentity];
			attribute<Eur_yr> Kji_gv          (..) := Results/Kapitaallasten/Kji_gv[nr_orgentity];
			attribute<Eur_yr> Kmi_gv          (..) := Results/Kapitaallasten/Kmi_gv[nr_orgentity];
			attribute<Eur_yr> Kj_gv_incentive (..) := Results/Kapitaallasten/Kj_gv_incentive[nr_orgentity];
			attribute<Eur_yr> Kji_LTAS        (..) := Results/Kapitaallasten/Kji_LTAS[nr_orgentity];
			attribute<Eur_yr> Kmi_LTAS        (..) := Results/Kapitaallasten/Kmi_LTAS[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_30     (..) := Results/Kapitaallasten/Oji_s_LO_30[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_20     (..) := Results/Kapitaallasten/Oji_s_LO_20[nr_orgentity];
			attribute<Eur_yr> Oji_s_LO_15     (..) := Results/Kapitaallasten/Oji_s_LO_15[nr_orgentity];
			attribute<Eur_yr> Oji_s_gv        (..) := Results/Kapitaallasten/Oji_s_gv[nr_orgentity];
		}
		
		container InstallatiePerProduct := for_each_nedv(Classifications/Product/name
		, 'Results/InstallatiePerProduct/'+Classifications/Product/name+'[nr_orgentity]'
		, .
		, Classifications/Installatie)
		{
			container LastVervanging := for_each_nedv(
				Classifications/Product/name,
				'Results/InstallatiePerProduct/LastVervanging/'+Classifications/Product/name+'[nr_orgentity]',
				..,
				yr_uint16)
				{
					attribute<yr_uint16> KK (...) := Results/InstallatiePerProduct/LastVervanging/KK[nr_orgentity];
					attribute<yr_uint16> VT (...) := Results/InstallatiePerProduct/LastVervanging/VT[nr_orgentity];
					attribute<yr_uint16> DK (...) := Results/InstallatiePerProduct/LastVervanging/DK[nr_orgentity];
				}
			
			attribute<Invoer/Kengetallen/OverigeInstallaties/KK/Installatietypes> KK (..) := Results/InstallatiePerProduct/KK[nr_orgentity];
			attribute<Invoer/Kengetallen/OverigeInstallaties/VT/Installatietypes> VT (..) := Results/InstallatiePerProduct/VT[nr_orgentity];
			attribute<Invoer/Kengetallen/OverigeInstallaties/DK/Installatietypes> DK (..) := Results/InstallatiePerProduct/DK[nr_orgentity];
			
		}
	}
}
